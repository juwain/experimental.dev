---
layout: layouts/post.njk
title: Укрощаем режимы наложения в CSS
date: 2021-01-02T14:27:19.337Z
---
Недавно пришла в голову идея воссоздать такой эффект выборочного обесцвечивания на CSS:

![Кадр из фильма «Город грехов»](/images/1-yltnfq85-8a4wosrnczuiw.jpg "Кадр из фильма «Город грехов»")

С художественной точки зрения такой эффект уже давно заезжен, но мне была интересна именно техническая сторона вопроса. То есть задача — обесцветить всю картинку, при этом оставив нетронутым красный цвет.

Вот что получилось в результате экспериментов:

![Фотография с обесцвеченной частью](/images/1-kgtmsjaus_0ntg5ekgecbq.png "Фотография с обесцвеченной частью")

Оригинал фотографии взят [здесь](https://unsplash.com/@luiskcortes).

<iframe height="300" style="width: 100%;" scrolling="no" title="Blend modes selective desaturation effect" src="https://codepen.io/juwain/embed/preview/mxLJYj?height=300&theme-id=9939&default-tab=result" frameborder="no" loading="lazy" allowtransparency="true" allowfullscreen="true">
  See the Pen <a href='https://codepen.io/juwain/pen/mxLJYj'>Blend modes selective desaturation effect</a> by juwain
  (<a href='https://codepen.io/juwain'>@juwain</a>) on <a href='https://codepen.io'>CodePen</a>.
</iframe>

Давайте теперь разберёмся, как это работает.

Сразу стало понятно, что для решения нужно изготовить под конкретную картинку SVG-маску, затем наложить поверх цветной картинки чёрно-белую с вырезанной частью. В итоге, через дырку в чёрно-белом изображении будет просвечивать цветная. Но такое решение, с изготовлением маски вручную, неуниверсальное — под каждую картинку нужно отдельно делать SVG-маску, что довольно запарно и вообще не тру.

В поисках более универсального способа добиться нужного эффекта я решил попробовать сделать «маску на лету» из самого же оригинального изображения с помощью [режимов наложения](https://drafts.fxtf.org/compositing-1/#blending) (blend modes).

Если вы не слышали раньше об этой фиче, то вкратце опишу её. По умолчанию слои в CSS располагаются друг поверх друга и не «просвечивают»:

![Нормальный режим наложения по умолчанию](/images/1-fmbrjwkcft2bmbjshsi1ka.png "Нормальный режим наложения по умолчанию")

А можно сделать так, чтобы слои не просто показывались один над другим, а «смешивались» по определённому алгоритму:

![Умножающий режим наложения](/images/1-6na7ll_rcxehlapfxjhg7w.png "Умножающий режим наложения")

Режимы наложения пришли в CSS из Фотошопа благодаря сотрудникам компании Adobe. Но не все фотошоповские режимы наложения переехали в CSS — всего в нашем распоряжении есть 16 вариантов смешивания слоёв. Не буду вдаваться в подробности, с режимами наложения можно поиграть [в демке Сары Суэйдан](http://www.sarasoueidan.com/demos/css-blender/).

Но вернёмся к *селективному обесцвечиванию*.

Сначала наложим сверху на изображение его же копию с помощью псевдоэлемента:

```css
.photo {
  --source: url(https://juwain.github.io/static/girl.jpg);

  /* это нижний слой */
  background-image: var(--source);
}

.photo::after {
  /* это верхний слой */
  background-image: var(--source);
}
```

![Наслаивание двух одинаковых изображений в нормальном режиме наложения](/images/1-2pxarp_l_m9wepezh056qg.gif "Наслаивание двух одинаковых изображений в нормальном режиме наложения")

Дальше изменим у верхнего слоя режим наложения на `lighten`. При таком режиме тёмные участки начинают «просвечивать», а светлые — наоборот остаются непрозрачными:

![Режим наложения lighten](/images/1-1hg5ykh47im7v-4iu2r0w.png "Режим наложения lighten")

Режим наложения между слоями включается свойством `mix-blend-mode`.

```css
.photo::after {
  mix-blend-mode: lighten;
}
```

Получилось то, что нужно: тёмный фон верхнего слоя стал прозрачным, а светлые участки — нет:

![Наслаивание двух одинаковых изображений в режиме lighten](/images/1-l6g6zwl_ibukmfrxoxxawg.gif "Наслаивание двух одинаковых изображений в режиме lighten")

Далее обесцветим верхний слой с помощью CSS-фильтра:

```css
.photo::after {
  filter: grayscale(1);
}
```

Теперь верхний слой накладывается светлыми обесцвеченными участками на нижнюю цветную фотографию:

![Наслаивание двух одинаковых изображений в режиме lighten с одним обесцвеченным слоем](/images/1-1wzrhh7ti55nrnzeyduagg.gif "Наслаивание двух одинаковых изображений в режиме lighten с одним обесцвеченным слоем")

Уже почти то, что нужно. Надо теперь сделать светлые участки верхнего слоя более непрозрачными.

Для этого снова воспользуемся режимы наложения. Помимо свойства `mix-blend-mode`, «смешивающее» два разных слоя, есть ещё одно свойство, меняющее режим наложения — это `background-blend-mode`. Оно задаёт режим смешивания фоновых элементов одного слоя: изображения, фонового цвета, градиента.

Итак, зададим верхнему слою серый фоновый цвет и режим смешивания картинки с ним `hard-light`. Это комбинированный режим, он чем-то похож на режим умножения — если коротко, он делает цвета ярче. Применительно в чёрно-белому изображению, этот режим сделает его светлые части более контрастными.

В итоге получим желаемый результат:

![Наслаивание двух одинаковых изображений в режиме lighten с одним обесцвеченным контрастным слоем](/images/1-xxrllxel6sf2hpijnms2fg.gif "Наслаивание двух одинаковых изображений в режиме lighten с одним обесцвеченным контрастным слоем")

---

Остаётся разобраться, какие именно цвета в таком сочетании режимов наложения делаются прозрачными, а какие нет.

Для этого я сделал демку со слоями с полосатыми линейными градиентами и вот что получилось:

![Наслаивание цветов с обесцвечиванием](/images/1-u-ewvolqzlopqlm6hzzbcw.png "Наслаивание цветов с обесцвечиванием")

Вживую можно посмотреть в [демке](https://codepen.io/juwain/pen/vRjaQb).

То есть при рассмотренной в этой статье комбинации режимов наложения прозрачными становятся области красного, синего и фиолетового оттенков, а желто-оранжевые, зелёные и голубые оттенки остаются непрозрачными.

Довольно любопытная фича, которую можно где-то использовать в своих проектах.